<h1>üìà –û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å</h1>

<div class="row g-4 mt-2">
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">4.2.1 –í—ã–±–æ—Ä–∫–∏: —Å —É—Å–ª–æ–≤–∏—è–º–∏</h5>
        <form id="form-clients-after-date">
          <div class="row g-2 align-items-end">
            <div class="col-7">
              <label class="form-label">–ö–ª–∏–µ–Ω—Ç—ã, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –¥–∞—Ç—ã</label>
              <input class="form-control" type="date" name="date" required />
            </div>
            <div class="col-5">
              <button class="btn btn-primary w-100" type="submit">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
          </div>
        </form>
        <div class="mt-3" id="res-clients-after-date"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">4.2.1 –í—ã–±–æ—Ä–∫–∏: –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü</h5>
        <form id="form-subs-by-status">
          <div class="row g-2 align-items-end">
            <div class="col-7">
              <label class="form-label">–°—Ç–∞—Ç—É—Å –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞</label>
              <input class="form-control" name="status" placeholder="–ê–∫—Ç–∏–≤–µ–Ω" />
            </div>
            <div class="col-5">
              <button class="btn btn-primary w-100" type="submit">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
          </div>
        </form>
        <div class="mt-3" id="res-subs-by-status"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-12">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">4.2.1 –ê–≥—Ä–µ–≥–∞—Ü–∏–∏ + –ø–æ–ª–Ω—ã–π SELECT</h5>
        <form id="form-revenue">
          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
              <input class="form-control" type="date" name="start_date" required />
            </div>
            <div class="col-md-3">
              <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
              <input class="form-control" type="date" name="end_date" required />
            </div>
            <div class="col-md-3">
              <label class="form-label">–ú–∏–Ω. –≤—ã—Ä—É—á–∫–∞ (‚ÇΩ)</label>
              <input class="form-control" type="number" step="0.01" min="0" name="min_revenue" placeholder="0" />
            </div>
            <div class="col-md-3">
              <button class="btn btn-success w-100" type="submit">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
            </div>
          </div>
        </form>
        <div class="mt-3" id="res-revenue"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-12">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h5>
        <form id="form-personal-finished">
          <div class="row g-2 align-items-end">
            <div class="col-md-4">
              <label class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
              <input class="form-control" type="date" name="start_date" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
              <input class="form-control" type="date" name="end_date" required />
            </div>
            <div class="col-md-4">
              <button class="btn btn-success w-100" type="submit">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
            </div>
          </div>
        </form>
        <div class="mt-3" id="res-personal-finished">
          <div id="res-personal-finished-summary"></div>
          <div id="res-personal-finished-table"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">4.2.2 –ü–æ–¥–∑–∞–ø—Ä–æ—Å—ã (–∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)</h5>
        <p class="text-muted small mb-3">
          –î–ª—è –∫–∞–∂–¥–æ–π –∑–æ–Ω—ã –≤ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è ‚Äî —ç—Ç–æ –ø—Ä–∏–º–µ—Ä –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞,
          –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç—Ä–æ–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
        </p>
        <form id="form-zones-min-equip">
          <div class="row g-2 align-items-end">
            <div class="col-7">
              <label class="form-label">–ú–∏–Ω. –∫–æ–ª-–≤–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</label>
              <input class="form-control" type="number" min="0" name="min_count" value="1" />
            </div>
            <div class="col-5">
              <button class="btn btn-primary w-100" type="submit">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
          </div>
        </form>
        <div class="mt-3" id="res-zones-min-equip"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">4.2.2 –ü–æ–¥–∑–∞–ø—Ä–æ—Å—ã (–Ω–µ–∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)</h5>
        <p class="text-muted small mb-3">
          –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π –ø–æ–¥–∑–∞–ø—Ä–æ—Å –≤—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω—é—é –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ –≤—Å–µ–º –∑–æ–Ω–∞–º –∏ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
          –î–∞–ª—å—à–µ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –≤—Å–µ –∑–æ–Ω—ã, –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã—à–µ —ç—Ç–æ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ.
        </p>
        <form id="form-zones-above-avg">
          <div class="row g-2 align-items-end">
            <div class="col-md-8">
              <label class="form-label">–ü–æ–¥–∑–∞–ø—Ä–æ—Å —Å—á–∏—Ç–∞–µ—Ç AVG()</label>
              <input class="form-control" value="–°—Ä–µ–¥–Ω—è—è –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" disabled />
            </div>
            <div class="col-md-4">
              <button class="btn btn-outline-primary w-100" type="submit">–ü–æ–∫–∞–∑–∞—Ç—å –∑–æ–Ω—ã</button>
            </div>
          </div>
        </form>
        <div class="mt-3" id="res-zones-above-avg"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">4.2.3 –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</h5>
        <div class="mb-3">
          <h6>INSERT –ó–æ–Ω–∞</h6>
          <form id="form-insert-zone" class="row g-2">
            <div class="col-md-4"><input class="form-control" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required/></div>
            <div class="col-md-4"><input class="form-control" name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"/></div>
            <div class="col-md-2"><input class="form-control" type="number" min="1" name="capacity" placeholder="–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å" required/></div>
            <div class="col-md-2">
              <select class="form-select" name="status">
                <option>–î–æ—Å—Ç—É–ø–Ω–∞</option>
                <option>–ù–∞ —Ä–µ–º–æ–Ω—Ç–µ</option>
                <option>–ó–∞–∫—Ä—ã—Ç–∞</option>
              </select>
            </div>
            <div class="col-12"><button class="btn btn-success" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button></div>
          </form>
          <div class="mt-2" id="res-insert-zone"></div>
        </div>

        <div class="mb-3">
          <h6>UPDATE –°—Ç–∞—Ç—É—Å –∑–æ–Ω—ã (–ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é)</h6>
          <form id="form-update-zone" class="row g-2">
            <div class="col-md-5"><input class="form-control" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–æ–Ω—ã" required/></div>
            <div class="col-md-5">
              <select class="form-select" name="status">
                <option>–î–æ—Å—Ç—É–ø–Ω–∞</option>
                <option>–ù–∞ —Ä–µ–º–æ–Ω—Ç–µ</option>
                <option>–ó–∞–∫—Ä—ã—Ç–∞</option>
              </select>
            </div>
            <div class="col-md-4"><button class="btn btn-warning w-100" type="submit">–û–±–Ω–æ–≤–∏—Ç—å</button></div>
          </form>
          <div class="mt-2" id="res-update-zone"></div>
        </div>

        <div>
          <h6>DELETE –ó–æ–Ω–∞ (–ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é)</h6>
          <form id="form-delete-zone" class="row g-2">
            <div class="col-md-6"><input class="form-control" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–æ–Ω—ã" required/></div>
            <div class="col-md-6"><button class="btn btn-danger w-100" type="submit">–£–¥–∞–ª–∏—Ç—å</button></div>
          </form>
          <div class="mt-2" id="res-delete-zone"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }
  function showAlert(containerId, msg, type='info'){
    const c = document.getElementById(containerId); clear(c);
    const div = document.createElement('div');
    div.className = `alert alert-${type}`;
    div.textContent = msg;
    c.appendChild(div);
  }
  function asDate(s){
    if(!s) return '';
    if(typeof s === 'string'){ return s.substring(0,10); }
    try { return new Date(s).toISOString().substring(0,10); } catch{ return '' }
  }
  function money(n){
    const num = Number(n||0);
    return num.toLocaleString('ru-RU', {style:'currency', currency:'RUB', maximumFractionDigits:2});
  }
  function renderTable(containerId, columns, rows){
    const c = document.getElementById(containerId); clear(c);
    if(!rows || rows.length===0){
      c.innerHTML = '<div class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
      return;
    }
    const wrap = document.createElement('div'); wrap.className = 'table-responsive';
    const table = document.createElement('table'); table.className = 'table table-sm table-striped align-middle mb-0';
    const thead = document.createElement('thead'); const trh = document.createElement('tr');
    for(const col of columns){ const th=document.createElement('th'); th.textContent = col.title; trh.appendChild(th); }
    thead.appendChild(trh); table.appendChild(thead);
    const tbody = document.createElement('tbody');
    for(const r of rows){
      const tr = document.createElement('tr');
      for(const col of columns){
        const td = document.createElement('td');
        const v = r[col.key];
        td.textContent = col.format? col.format(v, r): (v ?? '');
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody); wrap.appendChild(table);
    const meta = document.createElement('div'); meta.className = 'small text-muted mt-2'; meta.textContent = `–°—Ç—Ä–æ–∫: ${rows.length}`;
    c.appendChild(wrap); c.appendChild(meta);
  }
  async function postForm(url, formEl){
    const fd = new FormData(formEl);
    const res = await fetch(url, { method: 'POST', body: fd });
    const data = await res.json();
    return data;
  }

  // –ö–ª–∏–µ–Ω—Ç—ã –ø–æ—Å–ª–µ –¥–∞—Ç—ã
  document.getElementById('form-clients-after-date')?.addEventListener('submit', async e => {
    e.preventDefault();
    const cId = 'res-clients-after-date'; showAlert(cId, '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...', 'secondary');
    try{
      const data = await postForm('/about/query/clients-after-date', e.target);
      if(!data.success) return showAlert(cId, data.error||'–û—à–∏–±–∫–∞', 'danger');
      renderTable(cId, [
        {key: 'id_–∫–ª–∏–µ–Ω—Ç–∞', title:'ID'},
        {key: '—Ñ–∏–æ', title:'–§–ò–û'},
        {key: '–¥–∞—Ç–∞_—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', title:'–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', format: asDate},
      ], data.rows||[]);
    }catch(err){ showAlert(cId, '–û—à–∏–±–∫–∞: '+(err?.message||err), 'danger'); }
  });

  // –ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É
  document.getElementById('form-subs-by-status')?.addEventListener('submit', async e => {
    e.preventDefault();
    const cId = 'res-subs-by-status'; showAlert(cId, '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...', 'secondary');
    try{
      const data = await postForm('/about/query/subscriptions-by-status', e.target);
      if(!data.success) return showAlert(cId, data.error||'–û—à–∏–±–∫–∞', 'danger');
      renderTable(cId, [
        {key: 'id_–∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞', title:'ID'},
        {key: '—Ñ–∏–æ_–∫–ª–∏–µ–Ω—Ç–∞', title:'–ö–ª–∏–µ–Ω—Ç'},
        {key: '–Ω–∞–∑–≤–∞–Ω–∏–µ_—Ç–∞—Ä–∏—Ñ–∞', title:'–¢–∞—Ä–∏—Ñ'},
        {key: '–¥–∞—Ç–∞_–Ω–∞—á–∞–ª–∞', title:'–ù–∞—á–∞–ª–æ', format: asDate},
        {key: '–¥–∞—Ç–∞_–æ–∫–æ–Ω—á–∞–Ω–∏—è', title:'–û–∫–æ–Ω—á–∞–Ω–∏–µ', format: asDate},
        {key: '—Å—Ç–∞—Ç—É—Å', title:'–°—Ç–∞—Ç—É—Å'},
        {key: '—Ü–µ–Ω–∞', title:'–¶–µ–Ω–∞', format: money},
      ], data.rows||[]);
    }catch(err){ showAlert(cId, '–û—à–∏–±–∫–∞: '+(err?.message||err), 'danger'); }
  });

  // –í—ã—Ä—É—á–∫–∞ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º
  document.getElementById('form-revenue')?.addEventListener('submit', async e => {
    e.preventDefault();
    const cId = 'res-revenue'; showAlert(cId, '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...', 'secondary');
    try{
      const data = await postForm('/about/query/revenue-by-tariff', e.target);
      if(!data.success) return showAlert(cId, data.error||'–û—à–∏–±–∫–∞', 'danger');
      renderTable(cId, [
        {key: '—Ç–∞—Ä–∏—Ñ', title:'–¢–∞—Ä–∏—Ñ'},
        {key: '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', title:'–ö–æ–ª-–≤–æ'},
        {key: '–≤—ã—Ä—É—á–∫–∞', title:'–í—ã—Ä—É—á–∫–∞', format: money},
      ], data.rows||[]);
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—É—é —Å—É–º–º—É –ø–æ –≤—Å–µ–º —Å—Ç—Ä–æ–∫–∞–º
      const total = (data.rows||[]).reduce((acc, r) => acc + Number(r['–≤—ã—Ä—É—á–∫–∞']||0), 0);
      const c = document.getElementById(cId);
      const sumEl = document.createElement('div');
      sumEl.className = 'mt-2 fw-bold';
      sumEl.textContent = '–ò—Ç–æ–≥–æ: ' + money(total);
      c.appendChild(sumEl);
    }catch(err){ showAlert(cId, '–û—à–∏–±–∫–∞: '+(err?.message||err), 'danger'); }
  });

  // –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥
  document.getElementById('form-personal-finished')?.addEventListener('submit', async e => {
    e.preventDefault();
    const wrapId = 'res-personal-finished';
    const sumId = 'res-personal-finished-summary';
    const tblId = 'res-personal-finished-table';
    showAlert(sumId, '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...', 'secondary');
    clear(document.getElementById(tblId));
    try{
      const data = await postForm('/about/query/personal-finished', e.target);
      if(!data.success) return showAlert(sumId, data.error||'–û—à–∏–±–∫–∞', 'danger');
      const rows = data.rows||[];
      const totalCount = data.summary?.['–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ'] ?? rows.length;
      const totalSum = data.summary?.['—Å—É–º–º–∞'] ?? rows.reduce((a, r)=> a + Number(r['—Å—Ç–æ–∏–º–æ—Å—Ç—å']||0), 0);
      const sumWrap = document.getElementById(sumId); clear(sumWrap);
      const meta = document.createElement('div');
      meta.className = 'alert alert-info m-0';
      meta.textContent = `–ü—Ä–æ–≤–µ–¥–µ–Ω–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: ${totalCount}. –°—É–º–º–∞: ${money(totalSum)}`;
      sumWrap.appendChild(meta);
      renderTable(tblId, [
        {key: 'id', title:'ID'},
        {key: '–∫–ª–∏–µ–Ω—Ç', title:'–ö–ª–∏–µ–Ω—Ç'},
        {key: '—Ç—Ä–µ–Ω–µ—Ä', title:'–¢—Ä–µ–Ω–µ—Ä'},
        {key: '–Ω–∞—á–∞–ª–æ', title:'–ù–∞—á–∞–ª–æ', format: asDate},
        {key: '–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å_–º–∏–Ω', title:'–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)'},
        {key: '—Å—Ç–æ–∏–º–æ—Å—Ç—å', title:'–°—Ç–æ–∏–º–æ—Å—Ç—å', format: money},
      ], rows);
    }catch(err){ showAlert(sumId, '–û—à–∏–±–∫–∞: '+(err?.message||err), 'danger'); }
  });

  // –ó–æ–Ω—ã —Å –º–∏–Ω–∏–º—É–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º
  document.getElementById('form-zones-min-equip')?.addEventListener('submit', async e => {
    e.preventDefault();
    const cId = 'res-zones-min-equip'; showAlert(cId, '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...', 'secondary');
    try{
      const data = await postForm('/about/query/zones-min-equip', e.target);
      if(!data.success) return showAlert(cId, data.error||'–û—à–∏–±–∫–∞', 'danger');
      renderTable(cId, [
        {key: 'id_–∑–æ–Ω—ã', title:'ID'},
        {key: '–Ω–∞–∑–≤–∞–Ω–∏–µ', title:'–ù–∞–∑–≤–∞–Ω–∏–µ'},
        {key: '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è', title:'–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ'},
      ], data.rows||[]);
    }catch(err){ showAlert(cId, '–û—à–∏–±–∫–∞: '+(err?.message||err), 'danger'); }
  });

  // –ó–æ–Ω—ã —Å –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–π (–Ω–µ–∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥–∑–∞–ø—Ä–æ—Å)
  document.getElementById('form-zones-above-avg')?.addEventListener('submit', async e => {
    e.preventDefault();
    const cId = 'res-zones-above-avg'; showAlert(cId, '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...', 'secondary');
    try{
      const data = await postForm('/about/query/zones-above-avg-capacity', e.target);
      if(!data.success) return showAlert(cId, data.error||'–û—à–∏–±–∫–∞', 'danger');
      renderTable(cId, [
        {key: 'id_–∑–æ–Ω—ã', title:'ID'},
        {key: '–Ω–∞–∑–≤–∞–Ω–∏–µ', title:'–ù–∞–∑–≤–∞–Ω–∏–µ'},
        {key: '–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å', title:'–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å'},
      ], data.rows||[]);
      const avg = Number(data.summary?.avg_capacity ?? 0);
      const wrap = document.getElementById(cId);
      if(wrap && Number.isFinite(avg)){
        const avgEl = document.createElement('div');
        avgEl.className = 'small text-muted mt-2';
        avgEl.textContent = `–°—Ä–µ–¥–Ω—è—è –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ –≤—Å–µ–º –∑–æ–Ω–∞–º: ${avg.toFixed(2)}`;
        wrap.appendChild(avgEl);
      }
    }catch(err){ showAlert(cId, '–û—à–∏–±–∫–∞: '+(err?.message||err), 'danger'); }
  });

  // INSERT –∑–æ–Ω–∞
  document.getElementById('form-insert-zone')?.addEventListener('submit', async e => {
    e.preventDefault();
    const cId = 'res-insert-zone'; showAlert(cId, '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...', 'secondary');
    try{
      const data = await postForm('/about/op/insert-zone', e.target);
      if(!data.success) return showAlert(cId, data.error||'–û—à–∏–±–∫–∞', 'danger');
      showAlert(cId, `${data.message}. ID: ${data.zone_id}`, 'success');
      e.target.reset();
    }catch(err){ showAlert(cId, '–û—à–∏–±–∫–∞: '+(err?.message||err), 'danger'); }
  });

  // UPDATE –∑–æ–Ω–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
  document.getElementById('form-update-zone')?.addEventListener('submit', async e => {
    e.preventDefault();
    const cId = 'res-update-zone'; showAlert(cId, '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...', 'secondary');
    try{
      const data = await postForm('/about/op/update-zone-status', e.target);
      if(!data.success) return showAlert(cId, data.error||'–û—à–∏–±–∫–∞', 'danger');
      showAlert(cId, data.message||'–ì–æ—Ç–æ–≤–æ', 'success');
    }catch(err){ showAlert(cId, '–û—à–∏–±–∫–∞: '+(err?.message||err), 'danger'); }
  });

  // DELETE –∑–æ–Ω–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
  document.getElementById('form-delete-zone')?.addEventListener('submit', async e => {
    e.preventDefault();
    const cId = 'res-delete-zone'; showAlert(cId, '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...', 'secondary');
    try{
      const data = await postForm('/about/op/delete-zone', e.target);
      if(!data.success) return showAlert(cId, data.error||'–û—à–∏–±–∫–∞', 'danger');
      showAlert(cId, data.message||'–£–¥–∞–ª–µ–Ω–æ', 'success');
      e.target.reset();
    }catch(err){ showAlert(cId, '–û—à–∏–±–∫–∞: '+(err?.message||err), 'danger'); }
  });
</script>
